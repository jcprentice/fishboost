---
title: "Basic SEIDR Model"
author: "Jamie Prentice"
date: "`r Sys.Date()`"
output: pdf_document
papersize: a4
fontsize: 11pt
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

## Load libraries and source files

This pulls in all the necessary libraries and source files

```{r}
suppressPackageStartupMessages({
    source("libraries.R")
    source("source_files.R")
})
```

## Generating a params list

The first step is to generate a params list that contains the basic information, with some messages to note exactly what it's using. All elements in `make_parameters()` have default values, so these are just to see what you can add.

The params list might not fully do everything we want, but as it is just a basic R list, we can easily modify it afterwards.

```{r build-params}
params <- make_parameters(
    model_type = "SEIDR", # c("SIR", "SEIR", "SIDR", "SEIDR")
    dataset = "testing",
    name = "scen-1-1",
    setup = "fb_12_rpw", # "small", "fb_12", "fb_1", "fb_2", "single", etc.
    use_traits = "sit", # "all", "none", "sit", "si" etc.
    vars = c(sus = 1.0, inf = 1.5, tol = 0.5), # 0.5
    cors = c(si = 0.3, st = 0.2, it = 0.2), # 0.2
    group_layout = "fishboost", # "random", "family", "striped", "fishboost"
    trial_fe = "ildt", # ""
    donor_fe = "ildt", # ""
    txd_fe = "ildt", # ""
    weight_fe = "sildt", # ""
    weight_is_nested = TRUE,
    sim_new_data = "r" # c("bici", "r", "no", "etc_inf", "etc_ps")
)
```

This provides a short summary of the params
```{r, message=TRUE}
summarise_params(params)
```

## Generate pedigree and popn

Next we take the params file, set the groups and traits, and apply any fixed effects. Note that you these are piped into each other, but you can save the intermediate result at any point to examine what's happening (e.g. for bug fixing).

```{r build-popn}
popn <- make_pedigree(params) |>
    set_groups(params) |>
    set_traits(params) |>
    apply_fixed_effects(params)
```
It's worth taking a look at the `popn` file to see what it includes. The columns are:
```{r}
names(popn)
```
Where:

- `id`: the unique ID of the individual. Sires come first, then dams, then progeny.
- `sire` and `dam` of the individual (together with `id` this makes a pedigree).
- `sdp`: whether the individual is a sire, dam, or progeny.
- The `weight` in kg at start of experiment.
- Which `trial` the individual was assigned to.
- Which `group` the individual was assigned to.
- `donor`: if the individual was inoculated (1) or not (0).
- `GE`: a small tank dependent group effect.
- `sus_g`, `inf_g`, `tol_g`, `sus_e`, `inf_e`, `tol_e`: genetic and environmental values. These are normally distributed with mean 0.
- `sus`, `inf`, `tol`, `lat`, `det`: phenotypic values. These are log-normally distributed and incorporate any fixed effects.

A typical progeny looks like:

```{r}
popn[sdp == "progeny"][1]
```


## Simulate and plot epidemic

We now pass the population file `popn` and the parameters `params` to `simulate_epidemic()`, which will run the appropriate model and return a _new_ `popn` file with event times, final status, which generation infective they were, and the individual responsible for their infection. You can generate multiple realisations of the epidemic from the same inputs if you save the `popn` output each time.

```{r simulate-epidemic}
tic(); popn <- simulate_epidemic(popn, params); toc()
```

We can also use the generation value to calculate $R_0$, which is the mean across all groups of the ratio of secondary to primary infectives. Also it's useful to see how long the epidemic took until it completed (since this information is necessary for BICI to use).

```{r get-metrics, message = TRUE}
params$estimated_R0 <- get_R0(popn)
params$tmax <- get_tmax(popn, params)

message("Tmax = [", str_flatten_comma(round(params$tmax, 1)), "]")
```

The progeny we had before now looks like this, with the additional columns:

- `Tinf`: the infection time ($t:S\rightarrow E$). In actual data this is 0 for inoculated individuals, and missing for all others.
- `Tinc`: the incubation time ($t:E\rightarrow I$), missing in the data.
- `Tsym`: the time of symptoms ($t:I\rightarrow D$), present in data.
- `Tdeath`: the time of death ($t:D\rightarrow R$), present in data.
- `status`: which compartment the individual is in at the end of the epidemic (should only be `S` or `R`)
- `generation`: if an individual is a primary, secondary, tertiary etc. infective.
- `infected_by`: the id of the individual responsible for this infection (0 for inoculated individuals).
- `parasites` `TRUE` if an individual was infected. In actual data the sensitivity is not 100%.

```{r}
popn[sdp == "progeny"][1]
```


## Plot the epidemic

We can take a look at the time trajectory

```{r tj-plot, fig.cap = "Time trajectory of SEIDR model"}
plt <- plot_model(popn, params)
```

It's also important to look at the Kaplan-Meier survival plot.
```{r km-plot, fig.cap = "KM plot of SEIDR model, showing the proportion of each family surviving over time."}
plt2 <- basic_km(popn, params)
```


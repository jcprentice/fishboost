---
title: "MareksGenetics"
author: "Hector Marina"
date: "2023-11-21"
output:
  pdf_document: default
  html_document: default
editor_options:
  markdown:
    wrap: 72
---

```{=html}
<style>
body {
  text-align: justify}
</style>
```
### Analyzing Marek's disease transmission data

In this guide, we will analyse MDV transmission data from two different
transmission experiments using MDV-infected shedder birds of different
genetic lines to determine whether higher genetic resistance to symptoms
also reduces virus shedding and hence exposure dose and subsequent
disease severity in susceptible flockmates.

#### Load required packages

Load required packages for subsequent analyses. Possibly not all
packages loaded were used in the analyses included in the manuscript.

```{r setup, error=FALSE, warning=FALSE, message=FALSE, echo=FALSE}
Lpackages <- c("data.table", # Data manipulation
               "nlme",       # Linear mixed models
               "lme4",       # Linear mixed models
               "afex",       # Linear mixed models
               "car",        # Estimate VIF values
               "MuMIn",      # Automated model selection
               "drc",        # Fitting dose-response models
               "survival",   # Fitting survival models (proportional hazards regression model)
               "survminer","ordinal","multcomp","emmeans",
               "ggplot2",    # Representing results
               "cowplot",    # Representing results
               "chisq.posthoc.test")
Npackages <- Lpackages[!(Lpackages %in% installed.packages()[,"Package"])]
if (length(Npackages)) install.packages(Npackages)
lapply(Lpackages, require, character.only = TRUE)
rm(Lpackages,Npackages)
```


#### Load processed data

Load part of the environment generated by RB. Loaded files:

-   `donors67HVTPBS3`: Contains donors information after filter W36
    results. However, `Marek.disease` and `Dead.dates` information is
    missing in this file.
-   `Rdatsub2`: Contains recipients information after filter W36
    results.

```{r}
load("../data/processed/RB_analysis22Jan2021.RData")
#stop("Replicating original analyses")  
#load(file = "../data/processed/HM_analysis22Jan2021.RData")
```



#### Estimate differences in feather viral loads between shedder lines

The following analysis uses days post infection `DPI` and its
interaction with the lines as a random effect. Remove the line "W36"
from the data due to its inconsistent results and remove the levels that
do not exist after that using `droplevels()`:

```{r}
#donors67HVTPBS3=donors67HVTPBS2[dlineF!="W36"]
#donors67HVTPBS3=droplevels(donors67HVTPBS3)
donors67HVTPBS3[,levels(dlineF)]
```

Testing for significance of line fixed effect. The next functions use as
optimized `bobyqa`, which purpose is to minimize a function of many
variables by a trust region method that forms quadratic models by
interpolation.

```{r}
dfvlran1 = afex::lmer(log10fvl1e5 ~ dlineF + (dlineF|dayF) + (1|bandnum),data=donors67HVTPBS3,
                na.action=na.fail,
                REML=F,
                control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))

dfvlran2 = afex::lmer(log10fvl1e5 ~ 1 + (dlineF|dayF) + (1|bandnum),data=donors67HVTPBS3,
                na.action=na.fail,
                REML=F,
                control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))

anova(dfvlran1,dfvlran2)
```

```         
The inclusion of the `dlineF` has significant effect on the model.
```

Testing against the two different reference populations. In this case
the columns `dlineF2` and `dlineF3` are included, similar to `dlineF`
but with the classes reordered.

```{r}
dfvlran1.2 = afex::lmer(log10fvl1e5 ~ dlineF2 + (dlineF2|dayF) + (1|bandnum), data= donors67HVTPBS3,
                  na.action=na.fail,
                  REML=F,
                  control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(dfvlran1.2)$coef
```

```         
The results show that Line 6 is only marginally different from HVT. The rest are highly significant. Estimates show that all lines have higher FVL than HVT.
```

```{r}
dfvlran1.3 = afex::lmer(log10fvl1e5 ~ dlineF3 + (dlineF3|dayF) + (1|bandnum),data=donors67HVTPBS3,
                  na.action=na.fail,
                  REML=F,
                  control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(dfvlran1.3)$coef 
```

```         
The results show that Line 7 is not different from PBS. The rest are highly significant. Estimates show that all lines have lower FVL than PBS.
```

Represent the Feather viral loads of the different lines.

```{r}
#[1] "line6" "HVT"   "line7" "PBS"
donors67HVTPBS3[dlineF=="HVT",
 dlineF4:="15x7 Vacc"][dlineF=="line6",
 dlineF4:="Line 6"][dlineF=="line7",
 dlineF4:="Line 7"][dlineF=="PBS",
 dlineF4:="15x7 Unvacc"]

donors67HVTPBS3[,dlineF4:=factor(dlineF4,levels=c("15x7 Vacc","Line 6","Line 7","15x7 Unvacc"))]

{
plot(donors67HVTPBS3[,log10fvl1e5]~donors67HVTPBS3[,dlineF4],xlab="Shedder line",ylab="Log10(Shedder feather viral loads + 1e-5)",
ylim=c(-5,3),cex.lab=1.3)
abline(h=-5,col="grey",lty=2)#Grey line marks zero VL#
}
```

#### Evolution of feather viral loads in different shedder lines

The next mixed model combined the different shedder lines with the
values of the `dayc` and `dayc2` columns: - The variable `dayc` was
estimated by calculating the difference between the actual day and the
mean of all days [mean(day)=14.92118] (e.g., dayc=day-mean(day)).
Therefore, for days=10 its value will it be -4.930435. - The variable
`dayc2` is the quadratic form of the `dayc` variable, for days=10 its
value will it be (-4.930435)\*\*2=24.30919.

```{r}
plot(donors67HVTPBS3$dayc,donors67HVTPBS3$dayc2, xlab="Dayc", ylab="Dayc2")
```

This model includes both daily difference values to test their
suitability:

```{r}
dfvtl.12 = afex::lmer(log10fvl1e5 ~ dlineF*dayc + dlineF*dayc2 + (1|bandnum),data=donors67HVTPBS3,
                na.action=na.fail,
                REML=F,
                control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(dfvlt.12)$coef
```

Then we will apply the function `dredge()` to perform an automate model
selection. This function will generate a model selection table of models
with combinations (subsets) of fixed effect terms in the global model,
with optional model inclusion rules:

```{r}
dd.dfvlt.12 = MuMIn::dredge(dfvlt.12)
subset(dd.dfvlt.12,delta<4)
```

Considering the results obtained from the automate model selection we
selected the next model to study the evolution of feather viral loads in
different shedder lines:

```{r}
#donors67HVTPBS3[,levels(dlineF)]#"HVT"   "line6" "line7" "PBS" 
dfvlt.best2 = afex::lmer(log10fvl1e5 ~ dlineF*dayc + dayc2 + (1|bandnum),data=donors67HVTPBS3,
                   na.action=na.fail,
                   REML=F,
                   control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(dfvlt.best2)$coef
```

```{r}
#donors67HVTPBS3[,levels(dlineF2)]#"HVT"   "line6" "line7" "PBS" 
dfvlt.best3 = afex::lmer(log10fvl1e5 ~ dlineF2*dayc + dayc2 + (1|bandnum),data=donors67HVTPBS3,
                   na.action=na.fail,
                   REML=F,
                   control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(dfvlt.best3)$coef
```

```{r}
#donors67HVTPBS3[,levels(dlineF3)]#"PBS"   "line7" "line6" "HVT"
dfvlt.best4 = afex::lmer(log10fvl1e5 ~ dlineF3*dayc + dayc2 + (1|bandnum),data=donors67HVTPBS3,
                   na.action=na.fail,
                   REML=F,
                   control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(dfvlt.best4)$coef
```

```         
The line 15x7 vaccined or HVT showed the lowest log10(FVL+1e-5) concentration after correcting for the interaction with the days.
The variable `daysc` showed a positive estimate while `daysc2` a negative. The interaction between the line 15x7 unvaccined or PBS and `dayc` showed the lowest value compared to the rest of the lines. The log10(FVL+1e-5) concentration of line 15x7 unvaccined or PBS change the lowest across days in comparison with the the lines 6 and 7, but same results were observed for line 15x7 vaccined or HVT.
```

Estimate the Variance Inflation Factors of the variables included in the
model:

```{r}
car::vif(dfvlt.best2)
```

```         
Values are moderately low. The inclusion of these variables together should not lead to a variance inflation.
```

Represent the evolution of the `log10fvl1e5` concentrations in the
different lines including error bars. Save predicted values from the
fitted model in the variable `log10fvl1e5`

```{r}
donors67HVTPBS3_plot=copy(donors67HVTPBS3)
donors67HVTPBS3_plot$log10fvl1e5=predict(dfvlt.best2, newdata=donors67HVTPBS3_plot,re.form=NA)
```

Estimate the variance-covariance matrices of the terms included in the
model and calculate the corresponding variance of each bird included in
the model. These commands can be used to estimate the 95% of the
coefficient interval considering only the fixed effects included in the
model:

```{r}
mm <- model.matrix(terms(dfvlt.best2),donors67HVTPBS3_plot)
pvar1 <- diag(mm %*% Matrix::tcrossprod(vcov(dfvlt.best2),mm))
#tvar1 <- pvar1+VarCorr(dfvlt.best2)$bandnum[1]   #Must be adapted for more complex models
cmult <- 1.96 # 95% CI
```

Include the phenotypic variance in the shedders' file along with the
lower and upper confidence interval limits:

```{r}
donors67HVTPBS3_plot[,pvar1:=pvar1]
donors67HVTPBS3_plot[,plo:=log10fvl1e5-cmult*sqrt(pvar1)]
donors67HVTPBS3_plot[,phi:=log10fvl1e5+cmult*sqrt(pvar1)]
```

Correct Line variable names and reorder in the plot:

```{r}
donors67HVTPBS3_plot[dlineF4=="15x7 Vacc"  ,dlineF5:="15x7 (S) Vacc"]
donors67HVTPBS3_plot[dlineF4=="15x7 Unvacc",dlineF5:="15x7 (S)"]
donors67HVTPBS3_plot[dlineF4=="Line 6"     ,dlineF5:="Line 6 (R)"]
donors67HVTPBS3_plot[dlineF4=="Line 7"     ,dlineF5:="Line 7 (S)"]
donors67HVTPBS3_plot[,dlineF5:=factor(dlineF5,levels=c("15x7 (S) Vacc","Line 6 (R)","Line 7 (S)","15x7 (S)"))]
setnames(donors67HVTPBS3_plot,"dlineF5","Line")
```

Plotting the predicted values of the `log10fvl1e5` together with their
confidence interval estimate limits:

```{r}
colors_DFVL = c("cyan","blue","red","magenta")
g0 <- ggplot(donors67HVTPBS3_plot, aes(x=day, y=log10fvl1e5, colour=Line))+geom_point()+geom_line()
g0 = g0 + geom_pointrange(aes(ymin = plo, ymax = phi))
  #+    labs(title="95% CI based on fixed-effects uncertainty ONLY")
g0 = g0 + scale_x_continuous(breaks=seq(10,20,2)) # a tick mark is shown on every 2
g0= g0+ ylab("Fitted Shedder log10(FVL + 1e-5)") + xlab("Shedder DPI") + theme(text = element_text(size=20))
g0= g0+ guides(fill=guide_legend(title="Line"))
g0= g0+ scale_color_manual(values=c(colors_DFVL))
g0
```

```         
The figure shows two different trends: that of lines 6 & 7 and that of line 15x7 Vacc and Unvacc. This result was also shown in the models where no significant difference (interaction term) was found in the days post infection (DPI) effect between HVT & PBS (both same line), but PBS & HVT differed significantly from lines 6 & 7. 
Line 15x7 seems to reach their peak earlier than lines 6 & 7. With the exception of HVT, viral loads become more similar among lines with increasing DPI.
```



#### Recipient dose responses

The following analysis study the response of the recipients to the
feather viral loads of the shedders. Remove the line "W36" from the data
due to its inconsistent results and sort the data frame using
`setkey()`:

```{r}
#Rdatsub2=Rdatsub[dlineF!="W36"]
#data.table::setkey(Rdatsub2,experimentF,replicateF,dlineF)
Rdatsub2[,.N,by=c("experimentF","replicateF","dlineF")]
```

##### Recipients feather viral loads response

We will then express the shedders' sum of feather viral loads as
`log10DsumFVL1e5`. This parameter was estimated by applying the log10 to
the sum of all FVL concentrations of the shedders included in each
contact group (dline+day+replicate) + 1e-5: [log10(FLVsum + 1e-5)]. The
minimum value of this formula should be equal to 5, so this value is
added to plot the concentration of shedders per contact group
(`rawDFVLpos`).

```{r}
range(Rdatsub2[,log10fvl1e5])
```

Then we compare the logarithm concentration of the FVL of the shedders
by fitting a dose-responde model. A dose-response model is a general
model fitting function for analyses of concentration/dose data:

```{r}
Rdatmeans.rfvl = Rdatsub2[,mean(log10fvl1e5 + 5),by=.(rawDFVLpos)]
setkey(Rdatmeans.rfvl, rawDFVLpos)
head(Rdatmeans.rfvl)
```

```         
In this case V1 stands for the average of the Recipients (log10fvl1e5 + 5) values, while rawDFVLpos is the (log10(FLVsum + 1e-5)+5) average of contact sheeders of each contact group. 
```

```{r}
testrfvl.1 = drc::drm(V1 ~ rawDFVLpos, data = Rdatmeans.rfvl, type = "continuous", fct = LL.3(fixed=c(NA,7.5,NA)))
summary(testrfvl.1)
```

```         
In the dose-response model fct specifies a non-linear function in this case a three-parameter log-logistic model is fitting by adding LL.3 in which the upper limit is equal to 1 by default and  fixed specifies which parameters are fixed and at what value they are fixed. NAs for parameter that are not fixed. Type is by default = "continuous".
```

```{r}
plot(testrfvl.1, ylab="Recipients (log10fvl1e5+5) mean",xlab="Contact shedders (log10fvl1e5+5) mean")
```

```         
The image represent a linear relationship between these variables.
```

We will now run the same model without the 15x7 Vaccinated (HVT) line to
see how this changes the response curve:

```{r}
Rdatmeans.rfvl2 = Rdatsub2[dlineF!="HVT",mean(log10fvl1e5 + 5),by=.(rawDFVLpos)]
setkey(Rdatmeans.rfvl2, rawDFVLpos)
testrfvl.2 = drc::drm(V1 ~ rawDFVLpos, data = Rdatmeans.rfvl2, fct = LL.3(fixed=c(NA,7.5,NA)))
summary(testrfvl.2)
```

```         
The significance of the slope is lower when this group (line 15x7 Vaccinated or HVT) is excluded, compared to the total number of lines, but the estimate is higher in absolute value.
```

```{r}
plot(testrfvl.2, ylab="Recipients (log10fvl1e5+5) mean",xlab="Contact shedders (log10fvl1e5+5) mean")
```

##### Recipients disease response

We will now run the dose-response models, but adjusting for the disease
information, to see how the shedders' viral loads affect the incidence
of disease in the recipients:

```{r}
Rdatmeans.disease = Rdatsub2[,mean(diseased),by=.(rawDFVLpos)]
setkey(Rdatmeans.disease, rawDFVLpos)
test9.3 = drc::drm(V1 ~ rawDFVLpos, data = Rdatmeans.disease, fct = LL.2()) #, family="binomial"
summary(test9.3)
```

```         
In this model the type is still fixed by default as "continuous", however fct is equal now to LL.2, which provides a two-parameter log-logistic function where the lower limit is fixed at 0 and the upper limit is fixed at 1.
```

```{r}
plot(test9.3, ylab="Recipients binary-disease mean",xlab="Contact shedders (log10fvl1e5+5) mean")
```

Run the same model without the 15x7 Vaccinated (HVT) line to see how
this changes the response curve:

```{r}
Rdatmeans.disease2 = Rdatsub2[dlineF!="HVT",mean(diseased),by=.(rawDFVLpos)]
setkey(Rdatmeans.disease2, rawDFVLpos)
test9.4 = drc::drm(V1 ~ rawDFVLpos, data = Rdatmeans.disease2,fct = LL.2())#, family="binomial"
summary(test9.4)
```

```{r}
plot(test9.4, ylab="Recipients binary-disease mean", xlab="Contact shedders (log10fvl1e5+5) mean")
```

```         
The response curve is clearly driven by the HVT line, now the slope is much less significant and its stimate is lower compared to including all lines.
```

##### Recipients death response

We will now run the dose-response models, but adjusting for the
information on deaths, to see how the feather viral loads of the
shedders affect the incidence of dead recipients:

```{r}
Rdatmeans.dead = Rdatsub2[,mean(dead),by=.(rawDFVLpos)]
setkey(Rdatmeans.dead, rawDFVLpos)
testdead.1 = drc::drm(V1 ~ rawDFVLpos, data = Rdatmeans.dead, fct = LL.2())
summary(testdead.1)
```

```         
In this model the type is still fixed by default as "continuous", however fct is equal now to LL.2, which provides a two-parameter log-logistic function where the lower limit is fixed at 0 and the upper limit is fixed at 1.
```

```{r}
plot(testdead.1, ylab="Recipients binary-disease mean",xlab="Contact shedders (log10fvl1e5+5) mean")
```

Run the same model without the 15x7 Vaccinated (HVT) line to see how
this changes the response curve:

```{r}
Rdatmeans.dead2 = Rdatsub2[dlineF!="HVT",mean(dead),by=.(rawDFVLpos)]
setkey(Rdatmeans.dead2, rawDFVLpos)
testdead.2 = drc::drm(V1 ~ rawDFVLpos, data = Rdatmeans.dead2, fct = LL.2())
summary(testdead.2)
```

```{r}
plot(testdead.2, ylab="Recipients binary-disease mean", xlab="Contact shedders (log10fvl1e5+5) mean")
```

```         
The response curve is now less driven by the HVT line, the slope value and its significance are similar to when all lines were included.
```

All slopes were significant after removing the line 15x7 Vaccinated or
HVT, which clearly has a strong effect on all response variables fitted
in the models `mean(log10fvl1e5 + 5)`, `mean(diseased)` and
`mean(dead)`. Warning: As these models include the average of these
variables, contact groups with a small number of animals could affect
the results obtained (see 02-SummaryStatistics_procdata.Rmd for more
information).

##### Recipients infected response

Run the dose-response models, but adjusting for the infected
information, to see how the shedders' viral loads affect the incidence
of disease in the recipients. `Infected` represents `FVLNum>0` while
`disease` represents signs of Marek's disease found in the birds.

```{r}
Rdatmeans.Infected= Rdatsub2[,mean(infected),by=.(rawDFVLpos)]
setkey(Rdatmeans.Infected, rawDFVLpos)
testInfected.1 = try(drc::drm(V1 ~ rawDFVLpos, data = Rdatmeans.Infected, fct = LL.2()))
#summary(testInfected.1)
```

```         
The model did not converge.
```

```{r}
# plot(testInfected.1, ylab="Recipients binary-infected mean", xlab="Contact shedders (log10fvl1e5+5) mean")
```

Once we have analysed the four phenotypes we can plot these

```{r}
{par(mfrow=c(2,2))
plot(Rdatmeans.rfvl[, V1] ~ Rdatmeans.rfvl[, rawDFVLpos],xlim=c(3,7.5),xlab="Sum Shedder FVL",ylab="Contact FVL")
lines(fitted(testrfvl.1) ~ Rdatmeans.rfvl[, rawDFVLpos],col="blue")

plot(Rdatmeans.Infected[, V1] ~ Rdatmeans.Infected[, rawDFVLpos],ylim=c(0,1),xlim=c(3,7.5),xlab="Sum Shedder FVL",ylab="Contact infection status")
#lines(fitted(testInfected.1) ~ Rdatmeans.Infected[, rawDFVLpos],col="blue")

plot(Rdatmeans.disease[, V1] ~ Rdatmeans.disease[, rawDFVLpos],ylim=c(0,1),xlim=c(3,7.5),xlab="Sum Shedder FVL",ylab="Contact disease status")
lines(fitted(test9.3) ~ Rdatmeans.disease[, rawDFVLpos],col="blue")

plot(Rdatmeans.dead[, V1] ~ Rdatmeans.dead[, rawDFVLpos],ylim=c(0,1),xlim=c(3,7.5),xlab="Sum Shedder FVL",ylab="Contact mortality")
lines(fitted(testdead.1) ~ Rdatmeans.dead[, rawDFVLpos],col="blue")}
```


##### Summary barplot including all replicates

All different experiments and lines included in each one:

```{r}
unique(Rdatsub2[,.(experimentF,dlineF)])
```

Number of recipients that where not infected, diseased or dead per
experiment-line in total:

```{r}
Rdatsub[infected==0&diseased==0&dead==0,.N,by=.(dayF,dlineF,experimentF)]
```

Number of recipients who where not infected, diseased or dead per
experiment-line in those included in the study:

```{r}
Rdatsub2[infected==0&diseased==0&dead==0,.N,by=.(dayF,dlineF)]
```

Create a dataframe with that information:

```{r}
dt.u=data.table(DPI=rep(c(10,12,14,16,18,20),4),
                status="Uninfected",
                Nind=c(0,0,0,0,1,0,
                       1,1,8,1,0,0,
                       1,0,0,0,0,0,
                       0,0,0,0,0,0),
                treatment=c(rep("15x7 Vacc",6),
                            rep("Line 6",6),
                            rep("Line 7",6),
                            rep("15x7 Unvacc",6)))
```

Number of recipients who were infected but did not become ill or die per
experimental line among those included in the study:

```{r}
Rdatsub2[infected==1&diseased==0&dead==0,.N,by=.(dayF,dlineF)]
```

Create a dataframe with that information:

```{r}
dt.i=data.table(DPI=rep(c(10,12,14,16,18,20),4),
                status="Infected only",
                Nind=c(17,10,11,6,11,10,
                        9,3,3,0,2,1,
                        20,12,0,0,0,0,
                        0,1,0,0,0,0),
                treatment=c(rep("15x7 Vacc",6),
                            rep("Line 6",6),
                            rep("Line 7",6),
                            rep("15x7 Unvacc",6)))
```

Number of recipients who were infected and ill but did not die per
experimental line among those included in the study:

```{r}
Rdatsub2[infected==1&diseased==1&dead==0,.N,by=.(dayF,dlineF)]
```

Create a dataframe with that information:

```{r}
dt.id=data.table(DPI=rep(c(10,12,14,16,18,20),4),
                status="Infected and diseased",
                Nind=c(1,0,7,8,8,3,
                       14,16,6,15,13,19,
                       4,11,13,16,18,14,
                       18,16,14,12,9,8),
                treatment=c(rep("15x7 Vacc",6),
                            rep("Line 6",6),
                            rep("Line 7",6),
                            rep("15x7 Unvacc",6)))
```

Number of recipients who were infected and died per experimental line
among those included in the study:

```{r}
Rdatsub2[infected==1&diseased==1&dead==1,.N,by=.(dayF,dlineF)]
```

Create a dataframe with that information:

```{r}
dt.idd=data.table(DPI=rep(c(10,12,14,16,18,20),4),
                status="Infected, diseased and dead",
                Nind=c(1,0,1,2,0,0,
                       3,6,7,10,13,8,
                       0,1,5,12,12,12,
                       1,1,2,7,8,10),
                treatment=c(rep("15x7 Vacc",6),
                            rep("Line 6",6),
                            rep("Line 7",6),
                            rep("15x7 Unvacc",6)))
```

Combine dataframes and stimate the total number of individual per day
and experiment:

```{r}
dt=rbind(dt.u,dt.i,dt.id,dt.idd)
dtsums = dt[,sum(Nind),by=.(DPI,treatment)]
```

Sorts the dataframes and estimate the percentage of each category
considering all recipients (10-30) included in the different days post
infection and experiments:

```{r}
setkey(dtsums,DPI,treatment);setkey(dt,DPI,treatment)
dt=dtsums[dt]
dt[,NindP:=Nind/V1]
```

Transform the status of the birds to factor and sort correctly:

```{r}
dt[,statusF:=as.factor(status)]
dt[,statusF:= factor(statusF,levels=(statusF)[c(1,2,3,4)])]
dt[,levels(statusF)]
```

Transform days post infection and treatment into factors:

```{r}
dt[,DPI2:=as.factor(DPI)]
dt[,treatmentF:=as.factor(treatment)]
dt[,treatmentF:= factor(treatmentF,levels(treatmentF)[c(2,3,5,4,1)])]
dt[,levels(treatmentF)]
```

Plot the proportion of animals' status:

```{r fig.height=10, fig.width=18}
colors_all = c("#F2F1FC","#C2BCDE","#897BB9","#50318F")
plot1 <- ggplot(data = dt, aes(x = DPI2, y = NindP, fill = statusF)) +
  geom_col() + facet_grid(~treatmentF)

plot1 = plot1 + ylab("Contact bird proportion") + xlab("Shedder days post-infection") + theme(text = element_text(size=20))

plot1 = plot1 + guides(fill=guide_legend(title="Contact bird MD status"))

plot1 = plot1 + scale_fill_manual(values=c(colors_all))

#grid.arrange(plot1,ncol=4)#Didn't work.

plot1
```



##### Recipient overall line effects

In this section, we will explore the implications of the characteristics
of the different scenarios on the `log10fvl1e5`. For that we will fit
several linear mixed model including as random effect `(dlineF|dayF)`
and `(1|raneffect)`.

First, remove the levels non included in the factors contained in the
recipients dataframe:

```{r}
Rdatsub2=droplevels(Rdatsub2)
Rdatsub2[,levels(dlineF)]
```

Impact of the different variables into the feather viral loads in the
recipients:

```{r}
rtr1 = lmer(log10fvl1e5 ~ dlineF + experimentF + sexF + (dlineF|dayF) + (1|raneffect), data = Rdatsub2,
            REML=F,
            na.action=na.fail,
            control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(rtr1)$coef
```

Remove the fixed effect `experimentF` from the model:

```{r}
rtr2 = lmer(log10fvl1e5 ~ dlineF + sexF + (dlineF|dayF) + (1|raneffect), data = Rdatsub2,
            REML=F,
            na.action=na.fail,
            control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(rtr2)$coef
```

Remove the fixed effect `sexF` from the model:

```{r}
rtr3 = lmer(log10fvl1e5 ~ dlineF + (dlineF|dayF) + (1|raneffect),data = Rdatsub2,
            REML=F,
            na.action=na.fail,
            control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(rtr3)$coef
```

```{r}
rtr3.2 = lmer(log10fvl1e5 ~ dlineF2 + (dlineF2|dayF) + (1|raneffect),data = Rdatsub2,
              REML=F,
              na.action=na.fail,
              control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(rtr3.2)$coef
```

```{r}
rtr4 = lmer(log10fvl1e5 ~ 1 + (dlineF|dayF) + (1|raneffect),data = Rdatsub2,
            REML=F,
            na.action=na.fail,
            control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(rtr4)$coef
```

```{r}
anova(rtr3.2,rtr4)
```

```         
Line effect was not significant when comparing results from model 3.2 and 4.
```

```{r}
rtr5 = lmer(log10fvl1e5 ~ raw_log10DsumFVL1e5 + (dlineF|dayF) + (1|raneffect),data = Rdatsub2,
            REML=F,
            na.action=na.fail,
            control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(rtr5)$coef
```

```{r}
anova(rtr5,rtr4)
```

```         
All models had singularity issues. Singularity occur because the variance components is estimated as zero. This can be related to the included random effects structure which is over-fitted, usually because of too many random slopes, or because one of more variance components is actually very close to zero and there is insufficient data to estimate it above zero.
Main conclusions are the same described before. There is no a significant line effect by a strong effect of the shedders' fether viral loads.
```



##### Recipient Marek Disease

In this section we will explore the impact of the characteristics of the
different scenarios on the `diseased` phenotype. To do this, we will fit
several linear mixed models, including as random effects `(dlineF|dayF)`
and `(1|raneffect)`, in the same way as we have just done.

```{r}
rmdr1 = glmer(diseased~ dlineF + experimentF + sexF + (dlineF|dayF) + (1|raneffect),data = Rdatsub2,
              family=binomial,
              na.action=na.fail,
              control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(rmdr1)$coef
```

Remove the fixed effect `sexF` from the model:

```{r}
rmdr2 = glmer(diseased~ dlineF + experimentF + (dlineF|dayF) + (1|raneffect),data = Rdatsub2,
              family=binomial,
              na.action=na.fail,
              control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(rmdr2)$coef
```

Remove the fixed effect `experimentF` from the model:

```{r}
rmdr3 = glmer(diseased~ dlineF + (dlineF|dayF) + (1|raneffect),data = Rdatsub2,
              family=binomial,
              na.action=na.fail,
              control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(rmdr3)$coef
```

```{r}
rmdr3.2 = glmer(diseased~ dlineF2 + (dlineF2|dayF) + (1|raneffect),data = Rdatsub2,
                family=binomial,
                na.action=na.fail,
                control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(rmdr3.2)$coef
```

```{r}
rmdr3.3 = glmer(diseased~ dlineF3 + (dlineF3|dayF) + (1|raneffect),data = Rdatsub2,
                family=binomial,
                na.action=na.fail,
                control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(rmdr3.3)$coef
```

```{r}
rmdr4 = glmer(diseased~ 1 + (dlineF|dayF) + (1|raneffect),data = Rdatsub2,
              family=binomial,
              na.action=na.fail,
              control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(rmdr4)$coef
```

```{r}
anova(rmdr3,rmdr4)
```

```         
The parameters stimates are in the expected order of importance suggested by previous images. However, despite line is signficant, only line 15x7 Vaccinated or HVT is significantly different from the rest.
```

```{r}
rmdr5 = glmer(diseased~ raw_log10DsumFVL1e5 + (dlineF|dayF) + (1|raneffect),data = Rdatsub2,
              family=binomial,
              na.action=na.fail,
              control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(rmdr5)$coef
```

```{r}
anova(rmdr5,rmdr4)
```

```         
Additionally, Feather viral loads of the shedders showed a high significance in explaining the diseased animals in the contact experiments.
```

```{r}
rmdr6 = glmer(diseased~ dlineF2 + raw_log10DsumFVL1e5 + (dlineF2|dayF) + (1|raneffect),data = Rdatsub2,
              family=binomial,
              na.action=na.fail,
              control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(rmdr6)$coef
```

```{r}
anova(rmdr6,rmdr5)
```

```         
On top of that, including the `dlineF2` in the model does not improve the fit of the model when is already fitted the feather viral loads of the shedders`raw_log10DsumFVL1e5`.
```



##### Recipient mortality

In this section we will explore the impact of the characteristics of the
different scenarios on the `died` phenotype. To do this, we will perform
survival analyses by fitting a time-transform model using the current
age of the individuals. The model is fitted by using the functions
`Surv()`, which create a survival object used as a response variable
fitted using `coxph()`, which fits a Cox proportional hazards regression
model.

The survival object is created using the `DeathPCD` and `dead` variables
which contains the days alive post contact with the shedder birds and if
the recipients died before end of experiment (1), or if survived (0).

```{r}
y_dat_Rvacc1 = Surv(Rdatsub2[,DeathPCD], Rdatsub2[,dead])
y_dat_Rvacc1
```

We will now replicate the same models previously explored using `lmer()`
function. For this package, the `tt()` function indicates the age that
will be fitted in a time transform model using current age:
`tt=function(x,t,...) pspline(x + t)` and `cluster()` is an additional
variable that clusters the different observations or scenarios, this is
used when tehre are more than one individual per event.

```{r}
m1 = coxph(y_dat_Rvacc1 ~ dlineF2 + experimentF + sexF + tt(day) + cluster(raneffect), data= Rdatsub2, 
           na.action=na.fail, 
           tt=function(x,t,...) pspline(x + t))
summary(m1)$coef
```

Remove the fixed effect `sexF` from the model:

```{r}
m2 = coxph(y_dat_Rvacc1 ~ dlineF2 + experimentF + tt(day) + cluster(raneffect), data= Rdatsub2,
           na.action=na.fail,
           tt=function(x,t,...) pspline(x + t))
summary(m2)$coef
```

Remove the fixed effect `experimentF` from the model:

```{r}
m3 = coxph(y_dat_Rvacc1 ~ dlineF2 + tt(day) + cluster(raneffect),data= Rdatsub2,           
           na.action=na.fail,
           tt=function(x,t,...) pspline(x + t))
summary(m3)$coef
```

```{r}
m3.2 = coxph(y_dat_Rvacc1 ~ dlineF3 + tt(day) + cluster(raneffect),data= Rdatsub2,           
           na.action=na.fail,
           tt=function(x,t,...) pspline(x + t))
summary(m3.2)$coef
```

```         
The sex and experiment fixed effects were not significant, so removing them did not change the results. These show that the vaccinated line 15x7 is important in preventing death, but the lines 6 and 7 are not different from the unvaccinated line 15x7.
```

```{r}
m4 = coxph(y_dat_Rvacc1 ~ raw_log10DsumFVL1e5 + tt(day) + cluster(raneffect),data= Rdatsub2,           
           na.action=na.fail,
           tt=function(x,t,...) pspline(x + t))
summary(m4)$coef
```

```{r}
m5 = coxph(y_dat_Rvacc1 ~ raw_log10DsumFVL1e5 + dlineF2 + tt(day) + cluster(raneffect),data= Rdatsub2,           
           na.action=na.fail,
           tt=function(x,t,...) pspline(x + t))
summary(m5)$coef
```

```         
Including `raw_log10DsumFVL1e5` reduces the significance of the vaccinated lines against line 15x7, but they are still significant.
```

```{r}
m5.2 = coxph(y_dat_Rvacc1 ~ raw_log10DsumFVL1e5 + dlineF3 + tt(day) + cluster(raneffect),data= Rdatsub2,           
             na.action=na.fail,
           tt=function(x,t,...) pspline(x + t))
summary(m5.2)$coef
```

```         
Significance of the difference between line 15x7 vaccinate and line 15x7 unvaccinate decreases with the inclusion of DFVL (`raw_log10DsumFVL1e5`). However, the line becomes marginally significantly different from the line 15x7 unvaccinate!!
```

Representing the survival curves based on these results and considering
only the `dlineF2` in the model (with and without confidence intervals).

```{r}
form_Rvacc3 <- formula(y_dat_Rvacc1 ~ dlineF2)
cox_dat_Rvacc3 <- coxph(form_Rvacc3,data=Rdatsub2)
summary(cox_dat_Rvacc3)$coef
```

```{r}
colours_all = c("blue","red","magenta","cyan")
treat_df = data.table(dlineF2=as.factor(c("line6","line7","PBS","HVT")))
ggsurvplot(survfit(cox_dat_Rvacc3,data= Rdatsub2,newdat=treat_df),
                conf.int=F,
                legend.labs=c("Line 6 (R)","Line 7 (S)","15x7 (S)","Vacc 15x7 (S)"),
                ylim=c(0.6,1),
                xlab = "Days post-contact", ylab = "Contact survival",
                font.x=20,font.y=20,font.legend=15,legend=c(0.2,0.5), palette = colours_all)
```

```{r}
colours_all = c("blue","red","magenta","cyan")
treat_df = data.table(dlineF2=as.factor(c("line6","line7","PBS","HVT")))
ggsurvplot(survfit(cox_dat_Rvacc3,data= Rdatsub2,newdat=treat_df),
                conf.int=T,
                legend.labs=c("Line 6 (R)","Line 7 (S)","15x7 (S)","Vacc 15x7 (S)"),
                ylim=c(0.6,1),
                xlab = "Days post-contact", ylab = "Contact survival",
                font.x=20,font.y=20,font.legend=15,legend=c(0.2,0.5), palette = colours_all)
```



##### Shedders' days post infection (DPI effect) on Recipients

In this section we will explore the impact on the recipients of the Days
after the inoculation of the herpesvirus on the contact Shedders. To do
this, we will fit different linear mixed model analyses including
`log10fvl1e5` as response variable. The results pointed that
`dlineF*dayc + dayc2` is the best-fitting model for Shedder Feather
viral loads over time.

##### FVL

The next commands perform a backward elimination of the fixed effect
included in the model.

```{r}
rt4.1 = lmer(log10fvl1e5 ~ dlineF2*dayc + dayc2 + experimentF + sexF + (1|raneffect),data = Rdatsub2,REML=F)
summary(rt4.1)$coef
```

```{r}
rt4.1.1 = lmer(log10fvl1e5 ~ dlineF2*dayc + dayc2 + sexF + (1|raneffect),data = Rdatsub2,REML=F)
summary(rt4.1.1)$coef
```

```{r}
rt4.1.2 = lmer(log10fvl1e5 ~ dlineF2*dayc + dayc2 + (1|raneffect),data = Rdatsub2,REML=F)
summary(rt4.1.2)$coef
```

```{r}
rt4.1.3 = lmer(log10fvl1e5 ~ dlineF2 + dayc + dayc2 + (1|raneffect),data = Rdatsub2,REML=F)
summary(rt4.1.3)$coef 
```

```         
This results show that both day effects are significant, suggesting the need to include both in the model.
```

```{r}
anova(rt4.1.2,rt4.1.3)
```

```         
There is no significant difference between fit in the model `dlineF2*dayc` and `dlineF2 + dayc`.
```

```{r}
rt4.2.3 = lmer(log10fvl1e5 ~ dlineF3 + dayc + dayc2 + (1|raneffect),data = Rdatsub2,REML=F)
summary(rt4.2.3)$coef
```

```         
The estimates represent the effect of `dayc` and `dayc2`. The days post infection (`dayc`) have a strong effect on the recipients' feather viral loads compared to the quadratic transformation. These results also highlight the effect of the lines on the Feather viral loads of the recipients. The vaccinated line 15x7 showed a lower estimate, indicating that the vaccination line reduced the feather viral loads of the recipients. In addition, lines 7 and 6 showed negative estimates compared to the unvaccinated line 15x7.
```

The following models include the shedder's feather viral loads to test
their effect on the recipient's feather viral loads at the same time as
the shedder's days post infection:

```{r}
rt4.3 = lmer(log10fvl1e5 ~ dlineF3 + dayc + dayc2 + raw_log10DsumFVL1e5 + (1|raneffect),data = Rdatsub2,REML=F)
summary(rt4.3)$coef
```

```{r}
rt4.3.2 = lmer(log10fvl1e5 ~ dayc + dayc2 + raw_log10DsumFVL1e5 + (1|raneffect),data = Rdatsub2,REML=F)
summary(rt4.3)$coef
```

```{r}
anova(rt4.3,rt4.3.2)
```

```         
The ANOVA results show that the inclusion of the line does not affect the performance of the model. Note that the line is also related to Shedders' feather viral loads.
```

Represent the evolution of the Shedders' feather viral loads in the
different lines including error bars.

```{r}
Rdatsub2_plot=copy(Rdatsub2)
Rdatsub2_plot$log10fvl1e5=predict(rt4.1.3, Rdatsub2_plot=Rdatsub2_plot,re.form=NA)
```

Estimate the variance-covariance matrices of the terms included in the
model and calculate the corresponding variance of each bird included in
the model. These commands can be used to estimate the 95% of the
coefficient interval considering only the fixed effects included in the
model:

```{r}
mm <- model.matrix(terms(rt4.1.3),Rdatsub2_plot)
pvar1 <- diag(mm %*% tcrossprod(vcov(rt4.1.3),mm))
#tvar1 <- pvar1+VarCorr(rt4.1.3)$raneffect[1]  ## must be adapted for more complex models
cmult <- 1.96 ## 
```

Include the phenotypic variance in the shedders' file along with the
lower and upper confidence interval limits:

```{r}
Rdatsub2_plot[,pvar1:=pvar1]
Rdatsub2_plot[,plo:=log10fvl1e5-cmult*sqrt(pvar1)]
Rdatsub2_plot[,phi:=log10fvl1e5+cmult*sqrt(pvar1)]
```

Correct Line variable names and reorder in the plot:

```{r}
Rdatsub2_plot[dlineF=="HVT",
 Line:="15x7 (S) Vacc"][dlineF=="line6",
 Line:="Line 6 (R)"][dlineF=="line7",
 Line:="Line 7 (S)"][dlineF=="PBS",
 Line:="15x7 (S)"]
```

Plotting the predicted values of the `log10fvl1e5` together with their
confidence interval estimate limits:

```{r}
colors_DFVL = c("magenta","cyan","blue","red")
g0 <- ggplot(Rdatsub2_plot, aes(x=day, y=log10fvl1e5, colour=Line))+geom_point()+geom_line()
g0 = g0 + geom_pointrange(aes(ymin = plo, ymax = phi))
#+    labs(title="95% CI based on fixed-effects uncertainty ONLY")

# a tick mark is shown on every 2
g0 = g0 + scale_x_continuous(breaks=seq(10,20,2))


g0= g0+ ylab("Fitted Contact log10(FVL + 1e-5)") + xlab("Shedder DPI") + theme(text = element_text(size=20))
g0= g0+ guides(fill=guide_legend(title="Line"))
g0= g0+ scale_color_manual(values=c(colors_DFVL))
g0
```



##### Infection

The next commands perform a backward elimination of the non-significant
fixed effect included in the models fitting `infected` as the response
variable. These analyses were proposed to exclude them.

```{r}
it4.2 = glmer(infected ~ dlineF2*dayc + dayc2 + experimentF + sexF + (1|raneffect),data = Rdatsub2,
              family=binomial,control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(it4.2)$coef
```

```{r}
it4.2.2 = glmer(infected ~ dlineF2*dayc + dayc2 + experimentF + (1|raneffect),data = Rdatsub2,
                family=binomial,control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(it4.2.2)$coef
```

```{r}
it4.2.3 = glmer(infected ~ dlineF2 + dayc + dayc2 + experimentF + (1|raneffect),data = Rdatsub2,
                family=binomial,control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(it4.2.3)$coef
```

```{r}
anova(it4.2.3,it4.2.2)
```

```         
There is no difference between fitting `dlineF2*dayc` and `dlineF2 + dayc`.
```

```{r}
it4.2.4 = glmer(infected ~ dayc + dayc2 + experimentF + (1|raneffect),data = Rdatsub2,
                family=binomial,control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(it4.2.4)$coef
```

```{r}
anova(it4.2.3,it4.2.4)
```

```         
The inclusion of `experimentF` captures all the variance as it is the most significant fixed effect included in the model. This suggests that the infected animals could be biased by the year of the experiment, with the 2017 experiment having more infected recipients. There is no difference between including or not including `dlineF`. However, `experimentF`=Y2019 only includes line 6 and 7.
```

The following models include the shedder's feather viral loads
(`raw_log10DsumFVL1e5`) to test their effect on the likelihood of
infection (`infected`):

```{r}
it4.2.4.2 = glmer(infected ~ dayc + dayc2 + experimentF + raw_log10DsumFVL1e5 + (1|raneffect),data = Rdatsub2,
                  family=binomial,control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(it4.2.4.2)$coef
```

```         
No significant effect of the shedder's feather viral loads (`raw_log10DsumFVL1e5`) on the likelihood of infection.
```



##### Disease

The next commands perform a backward elimination of the non-significant
fixed effect included in the models fitting `diseased` as the response
variable.

```{r}
dit5.2 = glmer(diseased ~ dlineF2*dayc + dayc2 + experimentF + sexF + (1|raneffect),data = Rdatsub2,family=binomial,control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(dit5.2)$coef
```

```{r}
dit5.2.2 = glmer(diseased ~ dlineF2*dayc + dayc2 + experimentF + (1|raneffect),data = Rdatsub2,
                 family=binomial,control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(dit5.2.2)$coef
```

```{r}
dit5.2.3 = glmer(diseased ~ dlineF2*dayc + dayc2 + (1|raneffect),data = Rdatsub2,
                 family=binomial,control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(dit5.2.3)$coef
```

```{r}
dit5.2.4 = glmer(diseased ~ dlineF2 + dayc + dayc2 + (1|raneffect),data = Rdatsub2,
                 family=binomial,control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(dit5.2.4)$coef
```

```{r}
anova(dit5.2.4,dit5.2.3)
```

```         
These results highlight the importance of including the interaction `dlineF2*dayc`. When it is not included, `dayc` has a positive significant effect. But when it is included, we can see that it mainly affects line 7.
```

```{r}
dit5.2.3.2 = glmer(diseased ~ dlineF2*dayc + (1|raneffect),data = Rdatsub2,family=binomial,control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(dit5.2.3.2)$coef
```

```{r}
anova(dit5.2.3.2,dit5.2.3)
```

```         
These results indicate that `dayc2` can be removed from this model.
```

Use Line15x7 vaccinated as a reference in this model to compare
estimates with this Line:

```{r}
dit5.2.3.3 = glmer(diseased ~ dlineF3*dayc + (1|raneffect),data = Rdatsub2,
                   family=binomial,control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(dit5.2.3.3)$coef
```

```         
As described previously there is a significant difference between Line 15x7 vaccinated and unvaccinated.
```

The following models include the shedder's feather viral loads to test
their effect on the likelihood of disease at the same time as the
shedder's days post infection:

```{r}
dit5.2.3.4 = glmer(diseased ~ dlineF2*dayc + raw_log10DsumFVL1e5 + (1|raneffect),data = Rdatsub2,
                   family=binomial,control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(dit5.2.3.4)$coef
```

```         
The fixed effect `raw_log10DsumFVL1e5` captures all the variance explained by the rest of the fixed effects before.
```

```{r}
dit5.2.3.5 = glmer(diseased ~ dlineF2 + dayc + raw_log10DsumFVL1e5 + (1|raneffect),data = Rdatsub2,
                   family=binomial,control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(dit5.2.3.5)$coef
```

```{r}
anova(dit5.2.3.5,dit5.2.3.4)
```

```         
The interaction effect `dlineF2*dayc` is not longer significant.
```

```{r}
dit5.2.3.6 = glmer(diseased ~ dayc + raw_log10DsumFVL1e5 + (1|raneffect),data = Rdatsub2,
                   family=binomial,control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(dit5.2.3.6)$coef
```

```{r}
anova(dit5.2.3.5,dit5.2.3.6)
```

```         
The `dlineF2` effect is also no longer significant.
```

```{r}
dit5.2.3.7 = glmer(diseased ~ raw_log10DsumFVL1e5 + (1|raneffect),data = Rdatsub2,
                   family=binomial,control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(dit5.2.3.7)$coef
```

```{r}
anova(dit5.2.3.7,dit5.2.3.6)
```

```         
The `dayc` effect is also no longer significant.
```

##### Survival

The next commands perform a backward elimination of the non-significant
fixed effect included in the models fitting `survival` analyses. The
survival object is created using the `DeathPCD` and `dead` variables
which contains the days alive post contact with the shedder birds and if
the recipients died before end of experiment (1), or if survived (0).

```{r}
y_dat_Rvacc1 = Surv(Rdatsub2[,DeathPCD], Rdatsub2[,dead])
```

Running similar survival analyses as above incluiding backward
elimination:

```{r}
form_Rvacc3.2 <- formula(y_dat_Rvacc1 ~ dlineF2*dayc + dayc2 + experimentF + sexF + cluster(raneffect))
cox_dat_Rvacc3.2 <- coxph(form_Rvacc3.2,data= Rdatsub2)
summary(cox_dat_Rvacc3.2)$coef
```

```{r}
form_Rvacc3.2.2 <- formula(y_dat_Rvacc1 ~ dlineF2*dayc + dayc2 + experimentF + cluster(raneffect))
cox_dat_Rvacc3.2.2 <- coxph(form_Rvacc3.2.2,data= Rdatsub2)
summary(cox_dat_Rvacc3.2.2)$coef
```

Compare models changing the reference of the `dlineF2` fixed effect:

```{r}
form_Rvacc3.2.3 <- formula(y_dat_Rvacc1 ~ dlineF2*dayc + dayc2 + cluster(raneffect))
cox_dat_Rvacc3.2.3 <- coxph(form_Rvacc3.2.3,data= Rdatsub2)
summary(cox_dat_Rvacc3.2.3)$coef
```

```{r}
form_Rvacc3.3.3 <- formula(y_dat_Rvacc1 ~ dlineF3*dayc + dayc2 + cluster(raneffect))
cox_dat_Rvacc3.3.3 <- coxph(form_Rvacc3.3.3,data= Rdatsub2)
summary(cox_dat_Rvacc3.3.3)$coef
```

The following model include the shedder's feather viral loads to test
their effect on the likelihood of survival at the same time as the
shedder's days post infection:

```{r}
form_Rvacc3.2.4 <- formula(y_dat_Rvacc1 ~ dlineF2*dayc + dayc2 + raw_log10DsumFVL1e5 + cluster(raneffect))
cox_dat_Rvacc3.2.4 <- coxph(form_Rvacc3.2.4,data= Rdatsub2)
summary(cox_dat_Rvacc3.2.4)$coef
```

```         
The results have not changed from the previous test. There is a strong Line effect and a strong interaction between Line and Days post infection (`dlineF2*dayc`). In addition, the feather viral loads of the shedders is significant despite the inclusion of the other fixed effects in the model. It would be possible to add disease status plot to figure 6.
```

Represent the evolution of the `diseased` status in the different lines
considering the shedders' days post infection and including error bars.
Save predicted values from the fitted model `dit5.2.3.2`:

```{r}
Rdatsub2_plot=copy(Rdatsub2)
Rdatsub2_plot$DISEASE<- predict(dit5.2.3.2, newdata=Rdatsub2_plot,re.form=NA)
```

Estimate the variance-covariance matrices of the terms included in the
model and calculate the corresponding variance of each bird included in
the model. These commands can be used to estimate the 95% of the
coefficient interval considering only the fixed effects included in the
model:

```{r}
mm <- model.matrix(terms(dit5.2.3.2),Rdatsub2_plot)
pvar1 <- diag(mm %*% tcrossprod(vcov(dit5.2.3.2),mm))
#tvar1 <- pvar1+VarCorr(dit5.2.3.2)$raneffect[1]  ## must be adapted for more complex models
cmult <- 1.96 ## 
```

Include the phenotypic variance in the shedders' file along with the
lower and upper confidence interval limits:

```{r}
Rdatsub2_plot[,pvar1:=pvar1]
Rdatsub2_plot[,plo:=DISEASE-cmult*sqrt(pvar1)]
Rdatsub2_plot[,phi:=DISEASE+cmult*sqrt(pvar1)]
```

Correct Line variable names and reorder in the plot:

```{r}
Rdatsub2_plot[dlineF=="HVT",
 Line:="15x7 (S) Vacc"][dlineF=="line6",
 Line:="Line 6 (R)"][dlineF=="line7",
 Line:="Line 7 (S)"][dlineF=="PBS",
 Line:="15x7 (S)"]
```

Plotting the predicted values of the proportion of `DISEASE` together
with their confidence interval estimate limits:

```{r}
colors_DFVL = c("magenta","cyan","blue","red")
g0 <- ggplot(Rdatsub2_plot, aes(x=day, y=DISEASE, colour=Line))+geom_point()+geom_line()
g0 = g0 + geom_pointrange(aes(ymin = plo, ymax = phi))
#+    labs(title="95% CI based on fixed-effects uncertainty ONLY")
# a tick mark is shown on every 2
g0 = g0 + scale_x_continuous(breaks=seq(10,20,2))
g0= g0+ ylab("Fitted ln(proportion diseased)") + xlab("Shedder DPI") + theme(text = element_text(size=20))
g0= g0+ guides(fill=guide_legend(title="Line"))
g0= g0+ scale_color_manual(values=c(colors_DFVL))
g0
```
